<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Billing & Payments</title>
<style>
  body { font-family: Arial, sans-serif; padding: 12px; }
  label { display: block; margin: 8px 0 4px; }
  input, select { width: 100%; padding: 6px; margin-bottom: 12px; }
  button { padding: 8px 12px; margin-top: 8px; }
  .log-entry { border-bottom: 1px solid #ccc; padding: 6px 0; }
  .log-header { font-weight: bold; margin-top: 12px; }
</style>
<script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
  <h2>Billing & Payment Log</h2>

  <form id="charge-form">
    <label for="charge-type">Charge Type</label>
    <select id="charge-type" required>
      <option value="" disabled selected>Select type</option>
      <option value="retainer">Retainer</option>
      <option value="added fees">Added Fees</option>
      <option value="testimony">Testimony</option>
    </select>

    <label for="charge-date">Charge Date</label>
    <input type="date" id="charge-date" required />

    <label for="charge-amount">Charge Amount</label>
    <input type="number" id="charge-amount" step="0.01" min="0" required />

    <button type="submit">Add Charge</button>
  </form>

  <form id="payment-form" style="margin-top: 20px;">
    <label for="payment-type">Payment Type</label>
    <select id="payment-type" required>
      <option value="" disabled selected>Select type</option>
      <option value="retainer">Retainer</option>
      <option value="added fees">Added Fees</option>
      <option value="testimony">Testimony</option>
    </select>

    <label for="payment-date">Payment Date</label>
    <input type="date" id="payment-date" required />

    <label for="payment-amount">Payment Amount</label>
    <input type="number" id="payment-amount" step="0.01" min="0" required />

    <button type="submit">Add Payment</button>
  </form>

  <div id="log">
    <h3>Charge Log</h3>
    <div id="charges-log"></div>

    <h3>Payment Log</h3>
    <div id="payments-log"></div>
  </div>

<script>
  const t = TrelloPowerUp.iframe();

  // Load existing billing data
  function loadBillingData() {
    return t.get('card', 'shared', 'billingData').then(data => data || { charges: [], payments: [] });
  }

  // Save billing data
  function saveBillingData(data) {
    return t.set('card', 'shared', 'billingData', data);
  }

  // Render logs
  function renderLogs(data) {
    const chargesDiv = document.getElementById('charges-log');
    const paymentsDiv = document.getElementById('payments-log');

    chargesDiv.innerHTML = data.charges.length
      ? data.charges.map(c => `<div class="log-entry">${c.date} - ${c.type} - $${parseFloat(c.amount).toFixed(2)}</div>`).join('')
      : '<p>No charges recorded</p>';

    paymentsDiv.innerHTML = data.payments.length
      ? data.payments.map(p => `<div class="log-entry">${p.date} - ${p.type} - $${parseFloat(p.amount).toFixed(2)}</div>`).join('')
      : '<p>No payments recorded</p>';
  }

  // Add charge handler
  document.getElementById('charge-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const type = document.getElementById('charge-type').value;
    const date = document.getElementById('charge-date').value;
    const amount = parseFloat(document.getElementById('charge-amount').value);

    if (!type || !date || isNaN(amount) || amount <= 0) {
      alert('Please fill out all charge fields correctly.');
      return;
    }

    loadBillingData().then(data => {
      data.charges.push({ type, date, amount });
      return saveBillingData(data);
    }).then(() => {
      renderLogs(billingData);
      alert('Charge added.');
      this.reset();
      // Refresh Trello badge and back
      t.closePopup();
      t.notifyParent('billingDataChanged');
    });
  });

  // Add payment handler
  document.getElementById('payment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const type = document.getElementById('payment-type').value;
    const date = document.getElementById('payment-date').value;
    const amount = parseFloat(document.getElementById('payment-amount').value);

    if (!type || !date || isNaN(amount) || amount <= 0) {
      alert('Please fill out all payment fields correctly.');
      return;
    }

    loadBillingData().then(data => {
      data.payments.push({ type, date, amount });
      return saveBillingData(data);
    }).then(() => {
      renderLogs(billingData);
      alert('Payment added.');
      this.reset();
      t.closePopup();
      t.notifyParent('billingDataChanged');
    });
  });

  // Initialize page
  let billingData;
  loadBillingData().then(data => {
    billingData = data;
    renderLogs(data);
  });
</script>
</body>
</html>
