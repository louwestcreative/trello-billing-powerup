<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Payment</title>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; }
    label { display: block; margin-bottom: 0.5em; }
    input[type=number] { width: 100%; padding: 0.4em; font-size: 1em; }
    button { padding: 0.6em 1em; font-size: 1em; }
  </style>
</head>
<body>
  <form id="payment-form">
    <label>
      Amount: 
      <input type="number" id="amount" step="0.01" min="0" required />
    </label>
    <button type="submit">Save</button>
  </form>

  <script>
    const t = TrelloPowerUp.iframe();

    document.getElementById('payment-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const amountInput = document.getElementById('amount');
      const amount = parseFloat(amountInput.value);

      if (isNaN(amount) || amount < 0) {
        alert('Please enter a valid positive amount.');
        return;
      }

      // Fetch existing payments, add the new one, then save
      t.get('card', 'shared', 'payments').then(function(payments) {
        payments = payments || [];
        payments.push({
          amount: amount,
          date: new Date().toISOString()
        });
        return t.set('card', 'shared', 'payments', payments);
      }).then(function() {
        t.closeModal();
      }).catch(function(err) {
        console.error('Failed to save payment:', err);
        alert('Failed to save payment. Please try again.');
      });
    });
  </script>
</body>
</html>
