<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 10px;
      margin: 0;
    }
    .time-summary {
      background: #f4f5f7;
      border-radius: 3px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .time-summary h4 {
      margin: 0 0 8px 0;
      color: #172b4d;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      font-size: 14px;
    }
    .stat-label {
      color: #5e6c84;
    }
    .stat-value {
      font-weight: 600;
      color: #172b4d;
    }
    .time-entries {
      max-height: 150px;
      overflow-y: auto;
    }
    .time-entry {
      border-left: 3px solid #0079bf;
      padding: 8px;
      margin: 6px 0;
      background: white;
      border-radius: 3px;
    }
    .entry-description {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .entry-meta {
      font-size: 12px;
      color: #5e6c84;
    }
    .sync-button {
      width: 100%;
      padding: 8px;
      background: #0079bf;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-weight: 500;
      margin-top: 8px;
    }
    .sync-button:hover {
      background: #026aa7;
    }
    .loading {
      text-align: center;
      color: #5e6c84;
      padding: 20px;
    }
    .error {
      color: #eb5a46;
      padding: 10px;
      background: #ffebe6;
      border-radius: 3px;
      margin: 10px 0;
    }
    .setup-needed {
      text-align: center;
      padding: 20px;
      color: #5e6c84;
    }
  </style>
</head>
<body>
  <div id="content">
    <div class="loading">Loading time tracking data...</div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    var t = TrelloPowerUp.iframe();
    
    const HOURLY_RATES = {
      'Kitsap GAL': 200,
      'Pierce GAL': 125,
      'Kitsap MG GAL': 200,
      'Pierce CV': 126,
      'Kitsap CV': 75,
      'Pierce MG GAL': 125
    };
    
    const TOGGL_API_BASE = 'https://api.track.toggl.com/api/v9';
    
    function getPrimaryLabel(labels) {
      const labelOrder = [
        'Kitsap GAL', 'Pierce GAL', 'Kitsap MG GAL', 
        'Pierce CV', 'Kitsap CV', 'Pierce MG GAL'
      ];
      
      for (let labelName of labelOrder) {
        if (labels.some(l => l.name === labelName)) {
          return labelName;
        }
      }
      
      return null;
    }
    
    async function togglRequest(endpoint, options = {}) {
      const apiKey = await t.get('board', 'shared', 'togglApiKey');
      
      if (!apiKey) {
        throw new Error('Toggl API key not configured');
      }
      
      const auth = btoa(apiKey + ':api_token');
      
      const response = await fetch(TOGGL_API_BASE + endpoint, {
        ...options,
        headers: {
          'Authorization': 'Basic ' + auth,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      
      if (!response.ok) {
        throw new Error('Toggl API error: ' + response.status);
      }
      
      return response.json();
    }
    
    async function getTogglTimeEntries(projectName) {
      const workspaces = await togglRequest('/me/workspaces');
      const workspace = workspaces[0];
      
      const projects = await togglRequest('/workspaces/' + workspace.id + '/projects');
      const project = projects.find(p => p.name === projectName);
      
      if (!project) {
        return [];
      }
      
      const endDate = new Date().toISOString().split('T')[0];
      const startDate = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      const entries = await togglRequest(
        '/me/time_entries?start_date=' + startDate + '&end_date=' + endDate
      );
      
      return entries.filter(e => e.project_id === project.id);
    }
    
    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return hours + 'h ' + minutes + 'm';
    }
    
    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    async function loadTimeData() {
      const content = document.getElementById('content');
      
      try {
        const apiKey = await t.get('board', 'shared', 'togglApiKey');
        
        if (!apiKey) {
          content.innerHTML = `
            <div class="setup-needed">
              <p>‚öôÔ∏è Toggl API key not configured</p>
              <p><small>Use "Configure Toggl" button in board menu</small></p>
            </div>
          `;
          return;
        }
        
        const card = await t.card('name', 'labels');
        const projectName = card.name;
        const labels = card.labels;
        const primaryLabel = getPrimaryLabel(labels);
        
        if (!primaryLabel) {
          content.innerHTML = `
            <div class="error">
              No billing label found. Add a label to track time.
            </div>
          `;
          return;
        }
        
        const hourlyRate = HOURLY_RATES[primaryLabel];
        const timeEntries = await getTogglTimeEntries(projectName);
        
        const totalSeconds = timeEntries.reduce((sum, e) => sum + (e.duration || 0), 0);
        const totalHours = (totalSeconds / 3600).toFixed(2);
        const billableAmount = (totalHours * hourlyRate).toFixed(2);
        
        let html = `
          <div class="time-summary">
            <h4>üìä Time Summary</h4>
            <div class="stat-row">
              <span class="stat-label">Total Hours:</span>
              <span class="stat-value">${totalHours}h</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Hourly Rate:</span>
              <span class="stat-value">$${hourlyRate}/hour</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Billable Amount:</span>
              <span class="stat-value">$${billableAmount}</span>
            </div>
          </div>
        `;
        
        if (timeEntries.length > 0) {
          html += '<div class="time-entries">';
          html += '<h4>Recent Entries:</h4>';
          
          timeEntries.slice(-10).reverse().forEach(entry => {
            html += `
              <div class="time-entry">
                <div class="entry-description">${entry.description || 'No description'}</div>
                <div class="entry-meta">
                  ${formatDuration(entry.duration)} ‚Ä¢ ${formatDate(entry.start)}
                </div>
              </div>
            `;
          });
          
          html += '</div>';
        } else {
          html += '<p style="color: #5e6c84; text-align: center;">No time entries found for this project</p>';
        }
        
        html += '<button class="sync-button" onclick="loadTimeData()">üîÑ Refresh</button>';
        
        content.innerHTML = html;
        t.sizeTo('#content');
        
      } catch (error) {
        content.innerHTML = `
          <div class="error">
            Error loading time data: ${error.message}
          </div>
          <button class="sync-button" onclick="loadTimeData()">Try Again</button>
        `;
        t.sizeTo('#content');
      }
    }
    
    // Make loadTimeData available globally for refresh button
    window.loadTimeData = loadTimeData;
    
    // Load data on page load
    loadTimeData();
  </script>
</body>
</html>
