<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 12px;
      margin: 0;
      background: white;
    }
    .stats-box {
      background: #f4f5f7;
      padding: 12px;
      border-radius: 3px;
      margin-bottom: 12px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
    }
    .stat-row.total {
      font-size: 16px;
      font-weight: 600;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      margin-top: 8px;
    }
    button {
      width: 100%;
      padding: 8px 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .btn-primary {
      background: #5aac44;
      color: white;
    }
    .btn-primary:hover {
      background: #61bd4f;
    }
    .btn-secondary {
      background: #e2e4e6;
      color: #172b4d;
    }
    .btn-secondary:hover {
      background: #cdd2d4;
    }
    .message {
      text-align: center;
      color: #999;
      padding: 20px;
    }
    .error {
      color: #eb5a46;
    }
  </style>
</head>
<body>
  <div id="content">
    <div class="message">Loading Toggl data...</div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://louwestcreative.github.io/trello-billing-powerup/toggl-integration.js"></script>
  <script>
    var t = TrelloPowerUp.iframe();

    const HOURLY_RATES = {
      'Kitsap GAL': 200,
      'Pierce GAL': 125,
      'Kitsap MG GAL': 200,
      'Pierce CV': 126,
      'Kitsap CV': 75,
      'Pierce MG GAL': 125
    };

    function getPrimaryLabel(labels) {
      const labelOrder = [
        'Kitsap GAL', 'Pierce GAL', 'Kitsap MG GAL',
        'Pierce CV', 'Kitsap CV', 'Pierce MG GAL'
      ];

      for (let labelName of labelOrder) {
        if (labels.some(l => l.name === labelName)) {
          return labelName;
        }
      }
      return null;
    }

    async function loadTogglData() {
      const contentDiv = document.getElementById('content');
      const togglIntegration = window.TogglIntegration;

      try {
        const card = await t.card('name', 'labels');
        const primaryLabel = getPrimaryLabel(card.labels);

        if (!primaryLabel) {
          contentDiv.innerHTML = '<div class="message">Add a billing label to track hours</div>';
          return;
        }

        const hourlyRate = HOURLY_RATES[primaryLabel];
        const summary = await togglIntegration.getProjectSummary(t, card.name, hourlyRate);

        if (!summary) {
          contentDiv.innerHTML = `
            <div class="message">Toggl project not found</div>
            <button class="btn-primary" id="createProjectBtn">Create Toggl Project</button>
          `;

          document.getElementById('createProjectBtn').addEventListener('click', async function() {
            try {
              this.disabled = true;
              this.textContent = 'Creating...';
              await togglIntegration.createProjectForCard(t, card.name, primaryLabel, hourlyRate);
              await t.alert({ message: 'Project created!', duration: 3 });
              loadTogglData();
            } catch (error) {
              await t.alert({ message: 'Error: ' + error.message, duration: 5 });
              this.disabled = false;
              this.textContent = 'Create Toggl Project';
            }
          });
          return;
        }

        const totalHours = summary.totalHours;
        const billableAmount = summary.billableAmount;

        contentDiv.innerHTML = `
          <div class="stats-box">
            <div class="stat-row">
              <span>Hours Tracked:</span>
              <strong>${totalHours}h</strong>
            </div>
            <div class="stat-row">
              <span>Rate:</span>
              <strong>$${hourlyRate}/h</strong>
            </div>
            <div class="stat-row total">
              <span>Billable Amount:</span>
              <strong>$${billableAmount}</strong>
            </div>
          </div>
          <button class="btn-primary" id="addChargeBtn">Add Hours as Charge</button>
          <button class="btn-secondary" id="refreshBtn">Refresh Data</button>
        `;

        document.getElementById('addChargeBtn').addEventListener('click', async function() {
          if (parseFloat(totalHours) === 0) {
            await t.alert({ message: 'No hours to add', duration: 3 });
            return;
          }

          const charges = await t.get('card', 'shared', 'charges', []);
          charges.push({
            type: 'Hours',
            amount: parseFloat(billableAmount),
            description: totalHours + ' hours @ $' + hourlyRate + '/h',
            date: new Date().toISOString()
          });

          await t.set('card', 'shared', 'charges', charges);
          await t.alert({ message: 'Added $' + billableAmount + ' charge', duration: 3 });
        });

        document.getElementById('refreshBtn').addEventListener('click', function() {
          loadTogglData();
        });

      } catch (error) {
        if (error.message.includes('not configured')) {
          contentDiv.innerHTML = '<div class="message">Configure Toggl API key in board settings</div>';
        } else {
          contentDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
        }
      }
    }

    t.sizeTo('#content').then(loadTogglData);
  </script>
</body>
</html>
